<!DOCTYPE html>
<html lang="kr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="a tiny blog by gyunam park.">
  <meta name="author" content="Gyunam Park">
  <!-- OPEN GRAPH -->
  <meta property="og:type" content="website">
  <meta property="og:site_name" content="gyunam.blog">
  <!-- 파비콘(favicon) -->
  <link rel="icon" href="/resources/favicon/favicon.ico" type="image/x-icon">
  <!-- canonical URL -->
  <link rel="canonical" href="https://www.gyunam.blog/">
  
  <link rel="stylesheet" href="/styles.css">
  <title>gyunam.blog</title>
</head>
<body>
  <header>
  <div class="header-container">
    <a class="header-title" href="/">gyunam.blog</a>
    <nav class="header-nav">
      <ul class="header-tag-list">
        <li class="header-tag-list-item">
          <a href="/tags/11ty/">11ty (1)</a>
        </li>
        <li class="header-tag-list-item">
          <a href="/tags/express/">express (6)</a>
        </li>
        <li class="header-tag-list-item">
          <a href="/tags/weekly/">weekly (16)</a>
        </li>
        <li class="header-tag-list-item">
          <a href="/tags/sprinter/">sprinter (2)</a>
        </li>
        <li class="header-tag-list-item">
          <a href="/tags/toy/">toy (1)</a>
        </li>
      </ul>
      <ul class="header-tag-list">
        <li class="header-tag-list-item">
          <a href="/tags/git/">git (1)</a>
        </li>
        <li class="header-tag-list-item">
          <a href="/tags/shell/">shell (1)</a>
        </li>
      </ul>
    </nav>
  </div>
</header>
  <main>
    
  <article>
    <h1>[express] axios 패키지</h1>

    
      <p class="subtitle">더 편한 fetch 를 위한 패키지</p>
    

    <p>강의에서 배웠던 axios 패키지를 사용해보려고 한다.</p>
<p>웹서비스를 개발 할 때 다른 외부의 api 를 가져와서 사용하는 것은 굉장히 흔하다고 한다. 그래서 이번에는 나도 외부의 api를 가져와서 사용해보기로 했다.</p>
<h2>nasascii</h2>
<p>발음에 유의해야 한다. nasa + ascii 를 합쳐봤는데, 나사스끼 로 되더라.</p>
<p>이번에 만들어볼 건 별 거 없다. 그냥 외부 api 잘 불러오고, 그걸로 뭔가 하기만 하면 될 것 같았다.</p>
<p>그래서 nasa open api 로 행성 이미지를 받은 뒤에, 아스키코드 아트로 변환해서 png 로 반환하는 아주 간단한 웹서버를 만들어보기로 한다. 절차 상으로는 간단하다! 해봐야 알겠지만.</p>
<h3>nasa open api</h3>
<p>한 마디로 정리가 가능하다. 무료다!!</p>
<p>물론 api key 를 신청해서 받아야 하는데, 이메일 주소와 이름만 적으면 묻지도 따지지도 않고 발급해준다.</p>
<p>외부 api 를 사용할 때 반드시 key 가 필요한 것은 아니다. 몇몇 api 는 key 없이도 가져와서 쓸 수 있다.</p>
<p>엄청난 재력을 가진 대기업의 외부 공개 api 거나, 커뮤니티의 기부로 운용되는 api 거나, 그냥 우리 집 고양이 tmi 같은 개인이 만들어둔 api 같은 것들이 있다.</p>
<p>다만 많은 경우 key 를 발급해서, key 가 있는 경우만 api 가 정상적으로 반환해주는데, 무분별한 사용을 막기 위해서다.</p>
<p>이 api 라는 것도 결국, url 로 온 요청을 데이터베이스에서 검색해서 서버가 어떤 특정한 로직을 실행한 후에 json 으로 응답해주는 것이다. 즉, 서버가 뭔가 일을 해야 하고, 주고 받는 데 데이터를 전송하는 품이 든다.</p>
<p>우주 정복을 노리는 외계인이 1초에 1억번씩 nasa api 를 호출해서 nasa 를 공격할 수 있다는 뜻이다! 그래서 나처럼 단순히 무료로 사용하는 사람은 하루 1,000번 호출이 한계로 지정되어 있다. 1,000번도 많은 거 아닌가 싶지만.</p>
<p>다른 api 는 어떨 지 모르겠는데, nasa open api key 는 이메일로 날라온다. 그리고 그걸 잃어버리면 안된다! 아예 새로 발급 받거나 해야한다.</p>
<p>api key를 받고 나서 코드를 작성할 때 알게 된 건데, 이번에 사용한 images-api 는 완전 무료 공개라서 api key 가 따로 필요없었다.</p>
<h3>axios</h3>
<p>axios 는 node.js와 웹브라우저를 위해 만들어진 promise 기반 http 클라이언트 다. 우리는 서버를 개발하고 있는데 왜 클라이언트를 쓰냐 할 수 있는데, 애초에 서버도 컴퓨터에서 실행하는 어떤 의미로는 클라이언트다. 그저 역활이
serve 하는 아이일 뿐.</p>
<p>아무튼 axios 는 데이터를 보내주는 쪽(서버) 와 데이터를 받아서 사용하는 쪽(웹브라우저) 둘 다 쓸 수 있다는 건데, 무려 동일한 코드 베이스로 실행 할 수 있다. 약간의 차이, node.js 는 http 모듈을, 웹브라우저 에서는 XMLHttpRequest 를 사용할 뿐이다.</p>
<h2>nasascii 프로젝트 생성하기</h2>
<p>최신화 된 npm 프로젝트 생성 4콤보를 실행한다.</p>
<blockquote>
<p>npm init -y</p>
</blockquote>
<blockquote>
<p>npm i --save express axios</p>
</blockquote>
<blockquote>
<p>npm pkg set type=&quot;module&quot;</p>
</blockquote>
<blockquote>
<p>npm pkg set scripts.dev=&quot;nodemon index.js&quot;</p>
</blockquote>
<p>여기서 신경 쓸 부분은 <strong>npm i --save express axios</strong> 다. node.js 에서는 띄어쓰기로 한번에 여러 패키지를 받을 수 있다!</p>
<pre class="language-text"><code class="language-text">
nasascii
├ node_modules
├ index.js
├ package-lock.json
├ package.json

</code></pre>
<h2>express 기본 코드 작성</h2>
<p>이제 기본 코드는 따로 어떤 요소가 있었지 생각하지 않고도 작성할 수 있다. 이것이 성장이라는 것인가!</p>
<pre class="language-javascript"><code class="language-javascript">
<span class="token keyword">import</span> express <span class="token keyword">from</span> <span class="token string">'express'</span>

<span class="token keyword">const</span> <span class="token constant">PORT</span> <span class="token operator">=</span> <span class="token number">3000</span>

<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">yes!!</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span>
  port<span class="token punctuation">,</span>
  <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">server running on port </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>port<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">)</span>

</code></pre>
<h2>images-api</h2>
<p>nasa api의 공식 문서 <a href="https://api.nasa.gov/">https://api.nasa.gov/</a> 의 nasa image and video library 항목을 참고하며 간단한 코드를 작성한다.</p>
<pre class="language-javascript"><code class="language-javascript">
<span class="token keyword">import</span> express <span class="token keyword">from</span> <span class="token string">'express'</span>
<span class="token keyword">import</span> axios <span class="token keyword">from</span> <span class="token string">'axios'</span>

<span class="token keyword">const</span> <span class="token constant">PORT</span> <span class="token operator">=</span> <span class="token number">3000</span>

<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> planet <span class="token operator">=</span> req<span class="token punctuation">.</span>query<span class="token punctuation">.</span>planet

  <span class="token keyword">const</span> url <span class="token operator">=</span> <span class="token string">'https://images-api.nasa.gov/search'</span>
  <span class="token keyword">const</span> parameter <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">q</span><span class="token operator">:</span> planet<span class="token punctuation">,</span>
    <span class="token literal-property property">media_type</span><span class="token operator">:</span> <span class="token string">'image'</span><span class="token punctuation">,</span>
    <span class="token literal-property property">keywords</span><span class="token operator">:</span> planet
  <span class="token punctuation">}</span>
  <span class="token keyword">const</span> response <span class="token operator">=</span> <span class="token keyword">await</span> axios<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">params</span><span class="token operator">:</span> parameter
  <span class="token punctuation">}</span><span class="token punctuation">)</span>

  <span class="token keyword">const</span> items <span class="token operator">=</span> response<span class="token punctuation">.</span>data<span class="token punctuation">.</span>collection<span class="token punctuation">.</span>items

  res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>items<span class="token punctuation">.</span>length<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span>
  <span class="token constant">PORT</span><span class="token punctuation">,</span>
  <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">server running on port </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">PORT</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">)</span>

</code></pre>
<p>localhost:8080/?planet=moon 과 같이 planet 쿼리를 넣으면 nasa 가 공개 한 이미지들 중 moon 이란 글자가 들어가고, keywords가 moon 인 사진 목록을 전달해준다.</p>
<p>q 는 query string의 약자다. 아니 쿼리 안에 쿼리가 또 들어간다고? 생각할 수 있는데, query 는 그냥 찾다 라는 단어일 뿐이다. 즉, 검색어로도 사용될 수 있는 것! 물론, 구글 검색 창 처럼 나름의 검색어 문법을 사용할 수 있다고 한다. 자세한 것은 다음에 쓸 일 있을 때 알아본다.</p>
<p>keywords 설정을 해주는 게 좋은데, 이걸 안 하면 행성과 관계없는 사진도 나온다. 처음에 api 테스트를 화성(mars)로 했는데, 웬 음악 페스티벌이 나왔었다. 그후로 부랴부랴 찾아서 keywords 를 추가했다.</p>
<p>근데 공식 사이트에는 아주 간단한 것만 적혀있어서, 공식 api 문서를 보고 작업해야 했다.</p>
<p><img src="/resources/express/2025-05-01-axios-package/1.png" alt="1"></p>
<p>api 문서가 굉장히 긴데, 다 볼 필요없고 내가 필요한 부분만 <strong>찾아서</strong> 보면 된다. 다행히 nasa 는 큰 단체라서 그런지 문서마다 hyper link 가 잘 되어있어서 쉽게 찾았다.</p>
<p>웹서버를 실행해서 확인하면, 2025년 5월 1일 기준으로 64 라는 결과 값이 나온다. 현재 nasa 에서 제공하고 있는 moon 이라는 글자가 들어가고 keywords가 planet 인 사진이 64개 있다는 의미다.</p>
<p>물론, 실제로는 당연히 더 많은 사진들이 nasa 에 있다. 다만, 우리는 nasa 에서 images-api 로 제공하는 사진들 중에서 우리가 원하는 조건들을 맞춰서 저만큼 줄어든 것이다. 달 사진이지만, 사진 제목은 moon 이 아닐 수도 있으니까. 그런 것까지 고려하면 훨씬 적어지는게 맞다.</p>
<p>의외로 고생한 부분은 items 를 받아오는 부분이었다.</p>
<pre class="language-javascript"><code class="language-javascript">
<span class="token keyword">const</span> items <span class="token operator">=</span> response<span class="token punctuation">.</span>data<span class="token punctuation">.</span>collection<span class="token punctuation">.</span>items

</code></pre>
<p>fetch 를 썼을 때처럼 response.json() 을 하려니까 안 되는 것이 아닌가! 한참을 이리저리 시도하다가 저런 형태로 받아와야 한다는 것을 알게 되었다.</p>
<p>좀 더 정확하게 말하면 미리 json 으로 바꿔져서 객체를 받는 정도의 차이가 있다.</p>
<p>.collection.items 는 nasa 가 보내주는 구조 형태로 보인다.</p>
<h2>이미지 표시</h2>
<p>이때까지는 텍스트로만 결과값을 내면 됐었기 때문에 신경 안 쓰고 있었지만, 이번에는 이미지를 출력해야하는 관계로 res.send() 에 들어갈 html 코드도 동적으로 만든다.</p>
<p>일단은 검색된 모든 사진을 표시해본다.</p>
<pre class="language-javascript"><code class="language-javascript">
<span class="token keyword">let</span> html <span class="token operator">=</span> <span class="token string">''</span>
html <span class="token operator">+=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;h1></span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>planet<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&lt;/h1></span><span class="token template-punctuation string">`</span></span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> item <span class="token keyword">of</span> items<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> links <span class="token operator">=</span> item<span class="token punctuation">.</span>links

  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> link <span class="token keyword">of</span> links<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> href <span class="token operator">=</span> link<span class="token punctuation">.</span>href
    html <span class="token operator">+=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;img src='</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>href<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">'>&lt;/img></span><span class="token template-punctuation string">`</span></span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>html<span class="token punctuation">)</span>

</code></pre>
<p>이야, 이번에도 역시나 고생했다.</p>
<p>처음에는 아무 생각없이 검색 결과 당 사진 하나씩 있는 줄 알고 아래와 같이 코드를 만들었었다.</p>
<pre class="language-javascript"><code class="language-javascript">
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> item <span class="token keyword">of</span> items<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> href <span class="token operator">=</span> item<span class="token punctuation">.</span>links
    html <span class="token operator">+=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;img src='</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>href<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">'/></span><span class="token template-punctuation string">`</span></span>
<span class="token punctuation">}</span>

</code></pre>
<p>그런데 실제로 웹브라우저에서 확인해보니 이미지가 안 나오는 문제가 있었다.</p>
<p>뭔가 이상하네 하고 이 links 자체를 출력해서 확인해보니..</p>
<pre class="language-json"><code class="language-json">
<span class="token punctuation">[</span>
  <span class="token punctuation">{</span>
    href<span class="token operator">:</span> 'https<span class="token operator">:</span><span class="token comment">//images-assets.nasa.gov/image/as17-134-20473/as17-134-20473~medium.jpg',</span>
    rel<span class="token operator">:</span> 'alternate'<span class="token punctuation">,</span>
    render<span class="token operator">:</span> 'image'<span class="token punctuation">,</span>
    width<span class="token operator">:</span> <span class="token number">1280</span><span class="token punctuation">,</span>
    size<span class="token operator">:</span> <span class="token number">101000</span><span class="token punctuation">,</span>
    height<span class="token operator">:</span> <span class="token number">1280</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    href<span class="token operator">:</span> 'https<span class="token operator">:</span><span class="token comment">//images-assets.nasa.gov/image/as17-134-20473/as17-134-20473~small.jpg',</span>
    rel<span class="token operator">:</span> 'alternate'<span class="token punctuation">,</span>
    render<span class="token operator">:</span> 'image'<span class="token punctuation">,</span>
    width<span class="token operator">:</span> <span class="token number">640</span><span class="token punctuation">,</span>
    size<span class="token operator">:</span> <span class="token number">32000</span><span class="token punctuation">,</span>
    height<span class="token operator">:</span> <span class="token number">640</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    href<span class="token operator">:</span> 'https<span class="token operator">:</span><span class="token comment">//images-assets.nasa.gov/image/as17-134-20473/as17-134-20473~thumb.jpg',</span>
    rel<span class="token operator">:</span> 'preview'<span class="token punctuation">,</span>
    render<span class="token operator">:</span> 'image'<span class="token punctuation">,</span>
    width<span class="token operator">:</span> <span class="token number">640</span><span class="token punctuation">,</span>
    size<span class="token operator">:</span> <span class="token number">32000</span><span class="token punctuation">,</span>
    height<span class="token operator">:</span> <span class="token number">640</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    href<span class="token operator">:</span> 'https<span class="token operator">:</span><span class="token comment">//images-assets.nasa.gov/image/as17-134-20473/as17-134-20473~large.jpg',</span>
    rel<span class="token operator">:</span> 'alternate'<span class="token punctuation">,</span>
    render<span class="token operator">:</span> 'image'<span class="token punctuation">,</span>
    width<span class="token operator">:</span> <span class="token number">1920</span><span class="token punctuation">,</span>
    size<span class="token operator">:</span> <span class="token number">234000</span><span class="token punctuation">,</span>
    height<span class="token operator">:</span> <span class="token number">1920</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    href<span class="token operator">:</span> 'https<span class="token operator">:</span><span class="token comment">//images-assets.nasa.gov/image/as17-134-20473/as17-134-20473~orig.jpg',</span>
    rel<span class="token operator">:</span> 'canonical'<span class="token punctuation">,</span>
    render<span class="token operator">:</span> 'image'
  <span class="token punctuation">}</span>
<span class="token punctuation">]</span>
<span class="token comment">//...</span>
</code></pre>
<p>아뿔싸! 나만 해도 이 글을 쓸 때 여러 사진을 넣는데, nasa 라고 안 그럴까! 하나의 글 또는 앨범에 여러 사진이 있을 수 있다는 것을 깨달았다.</p>
<p>그래서 내부적으로 한번 더 돌아서 출력하는 방법으로 해결했다.</p>
<p>이미지 링크를 href 라고 하는데, hypertext reference 의 약자로, 말그대로 html(hyper text markup language) 에서 특정 리소스를 참조해서 가져올 때 사용하는 것이다. 보통 우리는 이미지 주소라고 말하는 부분이다.</p>
<h2>하나만 랜덤으로 받기</h2>
<p>사진이 많이 표시되는 것도 멋진 일이긴 한데, 나의 최종 목표는 랜덤한 한장을 ascii art 로 만드는 것이기 때문에, 이 목록을 하나의 배열에 넣고 그중에 하나만 랜덤으로 뽑아서 표시하는 것으로 바꾼다.</p>
<pre class="language-javascript"><code class="language-javascript">
<span class="token keyword">const</span> items <span class="token operator">=</span> response<span class="token punctuation">.</span>data<span class="token punctuation">.</span>collection<span class="token punctuation">.</span>items
<span class="token keyword">const</span> hrefs <span class="token operator">=</span> items<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">item</span> <span class="token operator">=></span> item<span class="token punctuation">.</span>links<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>href<span class="token punctuation">)</span>
<span class="token keyword">const</span> length <span class="token operator">=</span> hrefs<span class="token punctuation">.</span>length
<span class="token keyword">const</span> random <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">floor</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> length<span class="token punctuation">)</span>
<span class="token keyword">const</span> href <span class="token operator">=</span> hrefs<span class="token punctuation">[</span>random<span class="token punctuation">]</span>

<span class="token keyword">let</span> html <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;img src='</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>href<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">'/></span><span class="token template-punctuation string">`</span></span>

</code></pre>
<p>map 기능을 사용해서 items 내부의 href 들을 hrefs 에 넣는다. 원래는 습관적으로 for 반복문으로 만들었다가, 아, 맞다 map 이 있었지.. 하고 후다닥 수정했다.</p>
<p>혹시나 nasa 에 api 로 요청할 때 관련된 쿼리나 파라미터가 있는지 찾아봤지만, 없었다.</p>
<p>그냥 목록 받아서 내부에서 필터링 하세요~ 라고 되어있길레 그렇게 했다.</p>
<pre class="language-javascript"><code class="language-javascript">
 items<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">item</span> <span class="token operator">=></span> item<span class="token punctuation">.</span>links<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>href<span class="token punctuation">)</span>

</code></pre>
<p>이 코드에서 특이점이 있는데, links[0] 으로 첫번째 요소만 가져온다. 반환되는 json 을 유심히 살펴보니, 대부분의 한 앨범(?)에 여러 사진들이 있을 때, 이미지 크기별로 들어있는 경우가 많았다. 즉, 같은 사진인데 크기만 다르게 여러 개가 있는 것! 물론, 아닌 경우도 있지만, 그 경우는 애초에 전혀 관계 없는 사진인 경우가 많았다.</p>
<p>nasa 기준으로 첫번째 [0] 요소가 제일 큰 크기의 사진이었기 때문에 그냥 [0] 을 가져오는 것으로 고정했다.</p>
<p><img src="/resources/express/2025-05-01-axios-package/2.png" alt="2"></p>
<p>실행해보면 랜덤한 moon 사진이 잘 나타난다.</p>
<h2>중간 리팩토링</h2>
<p>랜덤하게 받은 사진을 ascii 코드로 바꾸는 코드를 만들기 전에 중간 코드 리팩토링을 한다.</p>
<p>뭔가 정해진 개발 흐름이 있는 건 아니고, 중간에 블로그에 기록을 남기다 보니 2가지 정도 아쉬운 부분이 있었다.</p>
<ol>
<li>
<p>try catch 없음
async await 를 쓸 때엔 반드시 try catch 를 써야지! 하고 생각하고 있었는데, 또 깜빡했다. 손가는 데로 코드 짜다보니 큰 틀 정하는게 아직 약하다. 이제는 try catch 를 먼저 적어두고 내부에 로직을 쓰는 습관을 들여야겠다.</p>
</li>
<li>
<p>?planet= 처럼 비어있을 때는?
물론 지금도 잘 동작한다. 왜냐면 애초에 내가 planet 쿼리를 안 넣어도 nasa api 에서 이미지들을 받아오기 때문이다. 검색어가 없을 때엔 그냥 최근에 추가된 이미지들을 보내주는 것 같다.(확실치 않음)</p>
</li>
</ol>
<p>그래도 기왕 나오는 거 하다못해 행성과 관련된 게 나왔으면 해서 태양계 행성 키워드들을 미리 정의해두고 그 중에서 하나를 랜덤으로 넣기로 한다.</p>
<pre class="language-javascript"><code class="language-javascript">
<span class="token comment">// index.js</span>
<span class="token keyword">import</span> express <span class="token keyword">from</span> <span class="token string">'express'</span>
<span class="token keyword">import</span> axios <span class="token keyword">from</span> <span class="token string">'axios'</span>

<span class="token keyword">const</span> <span class="token constant">PORT</span> <span class="token operator">=</span> <span class="token number">3000</span>
<span class="token keyword">const</span> <span class="token constant">SOLAR_SYSTEM_PLANETS</span> <span class="token operator">=</span> <span class="token punctuation">[</span>
  <span class="token string">'sun'</span><span class="token punctuation">,</span> <span class="token string">'mercury'</span><span class="token punctuation">,</span> <span class="token string">'venus'</span><span class="token punctuation">,</span>
  <span class="token string">'earth'</span><span class="token punctuation">,</span> <span class="token string">'mars'</span><span class="token punctuation">,</span> <span class="token string">'jupiter'</span><span class="token punctuation">,</span>
  <span class="token string">'saturn'</span><span class="token punctuation">,</span> <span class="token string">'uranus'</span><span class="token punctuation">,</span> <span class="token string">'neptune'</span>
<span class="token punctuation">]</span>

<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> planet <span class="token operator">=</span> req<span class="token punctuation">.</span>query<span class="token punctuation">.</span>planet

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>planet<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> length <span class="token operator">=</span> <span class="token constant">SOLAR_SYSTEM_PLANETS</span><span class="token punctuation">.</span>length<span class="token punctuation">;</span>
      <span class="token keyword">const</span> random <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">floor</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> length<span class="token punctuation">)</span>
      planet <span class="token operator">=</span> <span class="token constant">SOLAR_SYSTEM_PLANETS</span><span class="token punctuation">[</span>random<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">const</span> url <span class="token operator">=</span> <span class="token string">'https://images-api.nasa.gov/search'</span>

    <span class="token keyword">const</span> parameter <span class="token operator">=</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">q</span><span class="token operator">:</span> planet<span class="token punctuation">,</span>
      <span class="token literal-property property">media_type</span><span class="token operator">:</span> <span class="token string">'image'</span><span class="token punctuation">,</span>
      <span class="token literal-property property">keywords</span><span class="token operator">:</span> planet<span class="token punctuation">,</span>
      <span class="token literal-property property">description</span><span class="token operator">:</span> planet<span class="token punctuation">,</span>
      <span class="token literal-property property">title</span><span class="token operator">:</span> planet<span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">const</span> response <span class="token operator">=</span> <span class="token keyword">await</span> axios<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">params</span><span class="token operator">:</span> parameter
    <span class="token punctuation">}</span><span class="token punctuation">)</span>

    <span class="token keyword">const</span> items <span class="token operator">=</span> response<span class="token punctuation">.</span>data<span class="token punctuation">.</span>collection<span class="token punctuation">.</span>items
    <span class="token keyword">const</span> hrefs <span class="token operator">=</span> items<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">item</span> <span class="token operator">=></span> item<span class="token punctuation">.</span>links<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>href<span class="token punctuation">)</span>
    <span class="token keyword">const</span> length <span class="token operator">=</span> hrefs<span class="token punctuation">.</span>length
    <span class="token keyword">const</span> random <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">floor</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> length<span class="token punctuation">)</span>

    <span class="token keyword">const</span> href <span class="token operator">=</span> hrefs<span class="token punctuation">[</span>random<span class="token punctuation">]</span>
    <span class="token keyword">let</span> html <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;img src='</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>href<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">'/></span><span class="token template-punctuation string">`</span></span>

    res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>html<span class="token punctuation">)</span>

  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

<span class="token punctuation">}</span><span class="token punctuation">)</span>

app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span>
  <span class="token constant">PORT</span><span class="token punctuation">,</span>
  <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">server running on port </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">PORT</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">)</span>

</code></pre>
<p>try catch 추가는 거의 복붙만 하면 해결되는거라 순식간에 완료.</p>
<p>그리고 nasa imaga-api에 보내는 파라미터 값에 description 과 title 도 해당 planet 을 가지는 경우로 더 좁혔다. 테스트 삼아 태양계에 있는 위성들의 이름을 넣었는데, miranda 처럼 사람 이름이랑 똑같은 행성은 사람이 나오는 문제가 있었다.</p>
<p>그래서 에라, 모르겠다 하고 이미지 설명도 planet, 제목도 planet 으로 죄다 넣으니까 그 문제가 현저히 줄어들었다. 이게 말로만 듣던 검색 최적화인가!</p>
<p>쿼리로 planet 이 없을 때에는 태양계 행성들 중에 하나를 키워드로 넣도록 했다. 그러고 보니 정말 듣도보도 못한 행성도 결과값이 나오는걸까?</p>
<p><img src="/resources/express/2025-05-01-axios-package/3.png" alt="3"></p>
<p>잘 나온다.</p>
<h2>이미지를 ascii 코드로 변환하기</h2>
<p>이미지를 처리하기 위해서 jimp(javascript image manipulation program) 를 설치한다.</p>
<blockquote>
<p>npm i --save jimp</p>
</blockquote>
<p>물론, 이미지의 색상 버퍼를 읽어서 직접 처리하는 방법도 있지만, 귀찮다.</p>
<p>원리는 간단한데, .png 라는 확장자의 규칙에 따라서 들어가있는 데이터를 분류해서 처리하면 된다. 색상은 rgba(255,255,255,255) 가 width * height 개수 만큼 저장되어있다. 그래서 그냥 반복문으로 돌려서 처리하면 된다.</p>
<p>하지만 이번에는 nasa의 api 를 써보는 게 목표였기 때문에 그냥 jimp 를 쓴다.</p>
<p>먼저, ascii art 를 만들기 위해서는 밝기에 따라 표시할 ascii 문자를 정해줘야 한다.</p>
<pre class="language-javascript"><code class="language-javascript">
<span class="token keyword">const</span> <span class="token constant">ASCII_BRIGHTNESS</span> <span class="token operator">=</span> <span class="token string">'@%#*+=-:. '</span>

</code></pre>
<p>사람마다 다를 수 있지만, 인터넷에 검색해보면 사람들이 많이 쓰는 패턴이 있다. 그냥 왼쪽일수록 글자가 형태가 가능한 꽉꽉 차있고, 오른쪽으로 갈수록 비어보이면 된다.</p>
<pre class="language-javascript"><code class="language-javascript">
<span class="token keyword">const</span> image <span class="token operator">=</span> <span class="token keyword">await</span> Jimp<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>href<span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>image<span class="token punctuation">.</span>bitmap<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre>
<p>이제 아까 하나로 정했던 href 를 Jimp.read()로 가져오면 된다.</p>
<p>image.bitmap.data 로 출력해보면, 아래와 같이 아주 긴 문자열이 출력된다.</p>
<blockquote>
<p>Buffer 98 98 98 ff 99 99 99 ff 9b 9b 9b ff a3 a3 a3 ff...</p>
</blockquote>
<p>여기서 보면 특정한 주기로 반복되는 걸 알 수 있다.</p>
<p>98 98 98 ff 처럼 4개 단어가 하나의 묶음 처럼 반복되는데, 이게 아까 위에서 말했던 rgba 색상값이다. 이 4개 단어 1 묶음이 해상도 수 만큼 존재한다!</p>
<p>내 블로그에 사용된 favicon(웹페이지 이름 옆에 조그마한 아이콘)이 32x32 해상도인데 이 작은 크기의 그림만 해도 1024개의 묶음이 적혀있다!</p>
<p>그리고 컴퓨터는 이러한 묶음 말그대로 찰나의 순간에 읽어서 우리에게 보여주는 것이다.</p>
<p>아무튼 이런 데이터를 사용해서 우리는 이 rgba 라는 정보를 ascii 코드로 바꾸기만 하면 된다. 말은 언제나 쉽다.</p>
<pre class="language-javascript"><code class="language-javascript">
<span class="token keyword">const</span> image <span class="token operator">=</span> <span class="token keyword">await</span> Jimp<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>href<span class="token punctuation">)</span>
<span class="token keyword">const</span> buffer <span class="token operator">=</span> Array<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>image<span class="token punctuation">.</span>bitmap<span class="token punctuation">.</span>data<span class="token punctuation">)</span>
<span class="token keyword">const</span> width <span class="token operator">=</span> image<span class="token punctuation">.</span>bitmap<span class="token punctuation">.</span>width
<span class="token keyword">const</span> height <span class="token operator">=</span> image<span class="token punctuation">.</span>bitmap<span class="token punctuation">.</span>height

<span class="token keyword">let</span> html <span class="token operator">=</span> <span class="token string">''</span>

html <span class="token operator">+=</span> <span class="token string">'&lt;pre>'</span>

<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> y <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> y <span class="token operator">&lt;</span> height<span class="token punctuation">;</span> y<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> x <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> x <span class="token operator">&lt;</span> width<span class="token punctuation">;</span> x<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> index <span class="token operator">=</span> <span class="token punctuation">(</span>width <span class="token operator">*</span> y <span class="token operator">+</span> x<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">4</span>
    <span class="token keyword">const</span> red <span class="token operator">=</span> buffer<span class="token punctuation">[</span>index<span class="token punctuation">]</span>
    <span class="token keyword">const</span> green <span class="token operator">=</span> buffer<span class="token punctuation">[</span>index <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span>
    <span class="token keyword">const</span> blue <span class="token operator">=</span> buffer<span class="token punctuation">[</span>index <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">]</span>

    <span class="token keyword">const</span> char <span class="token operator">=</span> <span class="token string">'#'</span>
    html <span class="token operator">+=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;span style="color: rgb(</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>red<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">,</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>green<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">,</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>blue<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">)"></span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>char<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&lt;/span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  html <span class="token operator">+=</span> <span class="token string">'&lt;br>'</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

html <span class="token operator">+=</span> <span class="token string">'&lt;/pre>'</span><span class="token punctuation">;</span>

res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>html<span class="token punctuation">)</span>

</code></pre>
<p>픽셀 하나당 rgba 4개의 값이 한 묶음으로 있는 걸 이용해서 한 픽셀 한 픽셀을 '#' 으로 표시한다.</p>
<blockquote>
<p>const buffer = Array.from(image.bitmap.data)</p>
</blockquote>
<p>image.bitmap.data 는 javascript Buffer 객체로 전달하기 때문에 Array.from() 을 사용해서 순수한 색상값만 받아온다. Array.from() 이 없으면 <strong>&lt;Buffer ... &gt;</strong> 와 같은 형태로 오기 때문에 처리가 귀찮아진다. 실제로 내가 그랬다.</p>
<p>문자를 shift 하고 띄어쓰기를 trim 하고 해야하나..? 하는데, 그냥 Buffer 는 javascript 에서 쓰는 객체니까 Array.from 으로 하라는 github discussion 을 보고 적용했다.</p>
<p><img src="/resources/express/2025-05-01-axios-package/4.png" alt="4"></p>
<p>실행하면 일단..은 잘 동작하는 것처럼 보인다. 기본 글자 크기가 있기 때문에 사진의 전체가 한 화면에 들어오지 않는다. 원래라면 모니터의 한 픽셀이 무려 16배 이상이나 커진 상황이기 때문에 엄청난 크기의 결과물로 바뀐다.</p>
<p>궁금하면 웹브라우저의 화면 비율을 줄여서 전체 결과물을 볼 수 있지만 가능하면 하지 말자. 사진에 따라서는 엄청난 메모리와 작업 시간을 소모한다.</p>
<h2>이미지 비율을 줄이기</h2>
<p>이 문제를 해결하기 위해서는 크게 2가지 방법이 있다.</p>
<h3>1. 글자 크기를 줄이기</h3>
<p>기본 글자 크기가 16px 니까 이걸 2px 정도로 줄이면 되지 않을까 싶었다.</p>
<pre class="language-javascript"><code class="language-javascript">
html <span class="token operator">+=</span> <span class="token string">'&lt;pre style="font-size:2px; line-height:1px;">'</span>

</code></pre>
<p>이렇게 수정하기만 하면 된다.</p>
<p><img src="/resources/express/2025-05-01-axios-package/5.png" alt="5"></p>
<p>나쁘..지 않다!</p>
<p>다만, 웹 글꼴이 대게 가로보다 세로가 더 긴 경우가 많기 때문에 글꼴과 글꼴의 높이도 조금 조정하면 좋다.</p>
<pre class="language-javascript"><code class="language-javascript">
html <span class="token operator">+=</span> <span class="token string">'&lt;pre style="font-family: monospace; font-size:2px; line-height:1.2px; letter-spacing:0px;">'</span>

</code></pre>
<p><img src="/resources/express/2025-05-01-axios-package/6.png" alt="6"></p>
<p>이제 비율도 적절하고 결과도 거의 똑같이 나온다.</p>
<p>그런데 거의 똑같이 나온다는게 문제다! 나는 ascii art 감성을 원했던 건데, 이건 그냥 조금 희뿌연 이미지나 똑같아 보인다.</p>
<p>이걸 해결하기 위해서 이미지를 받아와서 처리할 때, 이미지 비율을 애초에 줄여서 처리하기로 한다. 비율을 조절하기 때문에 픽셀이 상대적으로 저해상도로 변할 테지만, 애초에 ascii art 는 저해상도일수록 감성이 산다!</p>
<h3>2. 비율 줄이기</h3>
<p>비율 줄이기를 하기 위해서 <a href="https://jimp-dev.github.io/jimp/api/jimp/classes/jimp/#resize">Jimp 공식문서</a> 를 보면서 작업하는데, 아무리 해도 resize 가 적용되지 않았다.</p>
<p>아니, 엄밀히 말하면 동작은 하는데 에러가 발생했을 뿐이지만.</p>
<p>한 시간 가량 이리저리 resize 를 시도해보았지만 동작하지 않았다. 결국 봉인해두었던 chatGPT 까지 썼는데, chatGPT도 이걸로 되야하는뎅? 이러고 있는게 아닌가.</p>
<p>그러다 우연히 문서에 pixelate 가 있는 걸 봤다.</p>
<pre class="language-javascript"><code class="language-javascript">
<span class="token keyword">const</span> image <span class="token operator">=</span> <span class="token keyword">await</span> Jimp<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>href<span class="token punctuation">)</span>

    <span class="token keyword">const</span> pixelSize <span class="token operator">=</span> <span class="token number">8</span>
    image<span class="token punctuation">.</span><span class="token function">pixelate</span><span class="token punctuation">(</span>pixelSize<span class="token punctuation">)</span>

    <span class="token keyword">const</span> buffer <span class="token operator">=</span> Array<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>image<span class="token punctuation">.</span>bitmap<span class="token punctuation">.</span>data<span class="token punctuation">)</span>
    <span class="token keyword">const</span> width <span class="token operator">=</span> image<span class="token punctuation">.</span>bitmap<span class="token punctuation">.</span>width
    <span class="token keyword">const</span> height <span class="token operator">=</span> image<span class="token punctuation">.</span>bitmap<span class="token punctuation">.</span>height

    <span class="token keyword">let</span> html <span class="token operator">=</span> <span class="token string">''</span>

    html <span class="token operator">+=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;img src=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>href<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
    html <span class="token operator">+=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;br></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>

    html <span class="token operator">+=</span> <span class="token string">'&lt;pre style="font-family: monospace; font-size:16px; line-height:60%; letter-spacing:0px;">'</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> y <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> y <span class="token operator">&lt;</span> height<span class="token punctuation">;</span> y <span class="token operator">+=</span> pixelSize<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> x <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> x <span class="token operator">&lt;</span> width<span class="token punctuation">;</span> x <span class="token operator">+=</span> pixelSize<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> index <span class="token operator">=</span> <span class="token punctuation">(</span>width <span class="token operator">*</span> y <span class="token operator">+</span> x<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">4</span>
        <span class="token keyword">const</span> red <span class="token operator">=</span> buffer<span class="token punctuation">[</span>index<span class="token punctuation">]</span>
        <span class="token keyword">const</span> green <span class="token operator">=</span> buffer<span class="token punctuation">[</span>index <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span>
        <span class="token keyword">const</span> blue <span class="token operator">=</span> buffer<span class="token punctuation">[</span>index <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">]</span>

        <span class="token keyword">const</span> char <span class="token operator">=</span> <span class="token string">'#'</span>
        html <span class="token operator">+=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;span style="color: rgb(</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>red<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">,</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>green<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">,</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>blue<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">)"></span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>char<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&lt;/span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      html <span class="token operator">+=</span> <span class="token string">'&lt;br>'</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    html <span class="token operator">+=</span> <span class="token string">'&lt;/pre>'</span><span class="token punctuation">;</span>

</code></pre>
<p>pixelate 라고? 검색해보니 pixel의 단위 만큼 이미지를 뭉게준다고 한다! 내가 원하던게 바로 이거였는데!</p>
<p><img src="/resources/express/2025-05-01-axios-package/7.png" alt="7"></p>
<p>이제 거의 완전하게 동작하고 있다! 이제 # 으로만 표시하던 부분을 명암에 비례해서 ascii 문자만 바꿔주면 된다.</p>
<h2>명암에 따라 ascii 바꾸기</h2>
<p>먼저 rgb 를 명도(brightness) 로 바꾸는 방법을 찾아야 했다.</p>
<p>제일 편한 방법은 image.greyscale() 로 흑백으로 만들어버리면, 그 픽셀당 값으로 구분할 수 있다고 한다.</p>
<p>근데 그렇게 하면 image 자체가 바뀌어 버리기 때문에 기각. 우회 방법으로 컬러 데이터만 복사해서 하는 방법이 있는데, 가뜩이나 느린 처리가 더 느려질까봐 기각.</p>
<p>이미 ascii 코드를 출력하기 위해서 모든 픽셀을 반복문으로 접근하고 있기 때문에 현재 픽셀 값을 바탕으로 처리하는 방법이 없는지 찾아보았다.</p>
<pre class="language-javascript"><code class="language-javascript">
<span class="token keyword">const</span> brightness <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">0.2126</span> <span class="token operator">*</span> red<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token number">0.7152</span> <span class="token operator">*</span> green<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token number">0.0722</span> <span class="token operator">*</span> blue<span class="token punctuation">)</span>
<span class="token keyword">const</span> charIndex <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">floor</span><span class="token punctuation">(</span><span class="token punctuation">(</span>brightness <span class="token operator">/</span> <span class="token number">255</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token constant">ASCII_BRIGHTNESS</span><span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> char <span class="token operator">=</span> <span class="token constant">ASCII_BRIGHTNESS</span><span class="token punctuation">[</span>charIndex<span class="token punctuation">]</span>

</code></pre>
<p>찾아보니 <strong>Luma 공식</strong> 이라는 게 있었다.</p>
<p>어디서 많이 들어봤는데, 그 루마썬팅 할 때..? 했는데 진짜 단어의 의미는 연관있는 거였다.</p>
<p>명도가 brightness 라고도 하지만, luminance 라는 전문 용어도 있었다!</p>
<p>이미지 처리에서는 이게 표준 공식처럼 쓰인다고 해서 바로 줏어와서 적용했다.</p>
<blockquote>
<p>l = (0.2126 * r) + (0.7152 * g) + (0.0722 * b)</p>
</blockquote>
<p>명도만 구하고 나니 그 다음은 쉬웠다.</p>
<p>(명도값/255)에 한참 전에 미리 정의해둔 (ascii_brightness 상수의 길이 - 1 ) 만큼 곱해준다.</p>
<p>명도값을 255로 나누는 이유는 (가장 어두움)0 ~ 1(가장 밝음) 로 정규화 하기 위해서다. 밝기가 제일 밝은 255로 온다고 가정해도 1이 된다.</p>
<p>ascii_brightness 상수의 길이에서 1 빼주는 이유는 간단하다. .length 는 길이를 반환하지만, 배열 index 는 0부터 시작이니까.</p>
<p>그래서 만약 가장 밝은 255가 오면 정규화가 되면서 1이 되고, 거기에 ascii_brightness 의 마지막 인덱스 9를 곱해서 ' ' 가 되는 것이다.</p>
<pre class="language-javascript"><code class="language-javascript">
<span class="token keyword">const</span> <span class="token constant">ASCII_BRIGHTNESS</span> <span class="token operator">=</span> <span class="token string">'@%#*+=-:. '</span>

</code></pre>
<p><img src="/resources/express/2025-05-01-axios-package/8.png" alt="8"></p>
<p>이제 진짜 완벽하다!</p>
<h2>전체 코드</h2>
<pre class="language-javascript"><code class="language-javascript">
<span class="token keyword">import</span> express <span class="token keyword">from</span> <span class="token string">'express'</span>
<span class="token keyword">import</span> axios <span class="token keyword">from</span> <span class="token string">'axios'</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Jimp <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'jimp'</span>

<span class="token keyword">const</span> <span class="token constant">PORT</span> <span class="token operator">=</span> <span class="token number">3000</span>
<span class="token keyword">const</span> <span class="token constant">SOLAR_SYSTEM_PLANETS</span> <span class="token operator">=</span> <span class="token punctuation">[</span>
  <span class="token string">'sun'</span><span class="token punctuation">,</span> <span class="token string">'mercury'</span><span class="token punctuation">,</span> <span class="token string">'venus'</span><span class="token punctuation">,</span>
  <span class="token string">'earth'</span><span class="token punctuation">,</span> <span class="token string">'mars'</span><span class="token punctuation">,</span> <span class="token string">'jupiter'</span><span class="token punctuation">,</span>
  <span class="token string">'saturn'</span><span class="token punctuation">,</span> <span class="token string">'uranus'</span><span class="token punctuation">,</span> <span class="token string">'neptune'</span>
<span class="token punctuation">]</span>
<span class="token keyword">const</span> <span class="token constant">ASCII_BRIGHTNESS</span> <span class="token operator">=</span> <span class="token string">'@%#*+=-:. '</span>

<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> axiosInstance <span class="token operator">=</span> axios<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token literal-property property">baseURL</span><span class="token operator">:</span> <span class="token string">'https://images-api.nasa.gov/'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">timeout</span><span class="token operator">:</span> <span class="token number">5000</span><span class="token punctuation">,</span>
  <span class="token literal-property property">headers</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token string-property property">'content-type'</span><span class="token operator">:</span> <span class="token string">'application/json'</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> planet <span class="token operator">=</span> req<span class="token punctuation">.</span>query<span class="token punctuation">.</span>planet

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>planet<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> length <span class="token operator">=</span> <span class="token constant">SOLAR_SYSTEM_PLANETS</span><span class="token punctuation">.</span>length
      <span class="token keyword">const</span> random <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">floor</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> length<span class="token punctuation">)</span>
      planet <span class="token operator">=</span> <span class="token constant">SOLAR_SYSTEM_PLANETS</span><span class="token punctuation">[</span>random<span class="token punctuation">]</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">const</span> parameter <span class="token operator">=</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">q</span><span class="token operator">:</span> planet<span class="token punctuation">,</span>
      <span class="token literal-property property">media_type</span><span class="token operator">:</span> <span class="token string">'image'</span><span class="token punctuation">,</span>
      <span class="token literal-property property">keywords</span><span class="token operator">:</span> planet<span class="token punctuation">,</span>
      <span class="token literal-property property">description</span><span class="token operator">:</span> planet<span class="token punctuation">,</span>
      <span class="token literal-property property">title</span><span class="token operator">:</span> planet<span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">const</span> response <span class="token operator">=</span> <span class="token keyword">await</span> axiosInstance<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'search'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">params</span><span class="token operator">:</span> parameter <span class="token punctuation">}</span><span class="token punctuation">)</span>

    <span class="token keyword">const</span> items <span class="token operator">=</span> response<span class="token punctuation">.</span>data<span class="token punctuation">.</span>collection<span class="token punctuation">.</span>items
    <span class="token keyword">const</span> hrefs <span class="token operator">=</span> items<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">item</span> <span class="token operator">=></span> item<span class="token punctuation">.</span>links<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>href<span class="token punctuation">)</span>
    <span class="token keyword">const</span> length <span class="token operator">=</span> hrefs<span class="token punctuation">.</span>length
    <span class="token keyword">const</span> random <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">floor</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> length<span class="token punctuation">)</span>

    <span class="token keyword">const</span> href <span class="token operator">=</span> hrefs<span class="token punctuation">[</span>random<span class="token punctuation">]</span>

    <span class="token keyword">const</span> image <span class="token operator">=</span> <span class="token keyword">await</span> Jimp<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>href<span class="token punctuation">)</span>

    <span class="token keyword">const</span> pixelSize <span class="token operator">=</span> <span class="token number">8</span>
    image<span class="token punctuation">.</span><span class="token function">pixelate</span><span class="token punctuation">(</span>pixelSize<span class="token punctuation">)</span>

    <span class="token keyword">const</span> buffer <span class="token operator">=</span> Array<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>image<span class="token punctuation">.</span>bitmap<span class="token punctuation">.</span>data<span class="token punctuation">)</span>
    <span class="token keyword">const</span> width <span class="token operator">=</span> image<span class="token punctuation">.</span>bitmap<span class="token punctuation">.</span>width
    <span class="token keyword">const</span> height <span class="token operator">=</span> image<span class="token punctuation">.</span>bitmap<span class="token punctuation">.</span>height

    <span class="token keyword">let</span> html <span class="token operator">=</span> <span class="token string">''</span>

    html <span class="token operator">+=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;img src=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>href<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">></span><span class="token template-punctuation string">`</span></span>
    html <span class="token operator">+=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;br></span><span class="token template-punctuation string">`</span></span>

    html <span class="token operator">+=</span> <span class="token string">'&lt;pre style="font-family: monospace; font-size:16px; line-height:60%; letter-spacing:0px;">'</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> y <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> y <span class="token operator">&lt;</span> height<span class="token punctuation">;</span> y <span class="token operator">+=</span> pixelSize<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> x <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> x <span class="token operator">&lt;</span> width<span class="token punctuation">;</span> x <span class="token operator">+=</span> pixelSize<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> index <span class="token operator">=</span> <span class="token punctuation">(</span>width <span class="token operator">*</span> y <span class="token operator">+</span> x<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">4</span>
        <span class="token keyword">const</span> red <span class="token operator">=</span> buffer<span class="token punctuation">[</span>index<span class="token punctuation">]</span>
        <span class="token keyword">const</span> green <span class="token operator">=</span> buffer<span class="token punctuation">[</span>index <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span>
        <span class="token keyword">const</span> blue <span class="token operator">=</span> buffer<span class="token punctuation">[</span>index <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">]</span>

        <span class="token keyword">const</span> brightness <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">0.2126</span> <span class="token operator">*</span> red<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token number">0.7152</span> <span class="token operator">*</span> green<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token number">0.0722</span> <span class="token operator">*</span> blue<span class="token punctuation">)</span>
        <span class="token keyword">const</span> charIndex <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">floor</span><span class="token punctuation">(</span><span class="token punctuation">(</span>brightness <span class="token operator">/</span> <span class="token number">255</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token constant">ASCII_BRIGHTNESS</span><span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">const</span> char <span class="token operator">=</span> <span class="token constant">ASCII_BRIGHTNESS</span><span class="token punctuation">[</span>charIndex<span class="token punctuation">]</span>

        html <span class="token operator">+=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;span style="color: rgb(</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>red<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">,</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>green<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">,</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>blue<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">)"></span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>char<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&lt;/span></span><span class="token template-punctuation string">`</span></span>
      <span class="token punctuation">}</span>
      html <span class="token operator">+=</span> <span class="token string">'&lt;br>'</span>
    <span class="token punctuation">}</span>

    html <span class="token operator">+=</span> <span class="token string">'&lt;/pre>'</span>

    res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>html<span class="token punctuation">)</span>

  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>e<span class="token punctuation">.</span>message<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

<span class="token punctuation">}</span><span class="token punctuation">)</span>

app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span>
  <span class="token constant">PORT</span><span class="token punctuation">,</span>
  <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">server running on port </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">PORT</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">)</span>

</code></pre>
<h2>마무리</h2>
<p>맨날 일을 벌리고 수습하느라 정신이 없다.</p>
<p>그냥 하루하루 강의에서 들었던거 복습해야지! 하고 시작하는 건데, 뭔가 조물조물 만들지 않으면 맘이 편하지 않다.</p>
<p>그만큼 배우는 건 많아서 좋지만!</p>
<p>이번에는 만들고 나니 뿌듯해서 따로 github repository 를 만들었다.</p>
<p><strong><a href="https://github.com/gyunam-bark/nasascii">https://github.com/gyunam-bark/nasascii</a></strong> 인데, 올리고 나니 README.md 는 적기 귀찮아서 대충 적었다..</p>
<p>api 통신에 대해서 조금 감이 잡혀가는 것 같다.</p>
<p>기왕 하는거 막더라도 제대로 api 서버를 만들어 보고 싶은데, 우리 스프린터 내부에서 만들어 볼만한 소재를 찾아봐야겠다.</p>

  </article>

  </main>
  <footer>
  <p>&copy; gyunam park</p>
</footer>
</body>
</html>